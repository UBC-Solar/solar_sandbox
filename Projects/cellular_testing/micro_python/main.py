import urequests
import ujson
from machine import UART
import utime


"""
This Micropython code is intended to be flashed onto the cellular module.

It reads an incoming CAN message from the cellular module's UART, packages it
into a JSON, and makes an HTTP POST request to a URL of your choice.
"""

server_url = "http://httpbin.org/post"  # Full URL for testing POST request
read_delay = 500  # Time delay between consecutive UART reads (in ms)


# Random CAN message generation for testing purposes
def generate_can_message():
    can_msg = dict()
    can_msg["message1"] =  b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message2"] =  b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message3"] =  b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message4"] =  b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message5"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message6"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message7"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message8"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message9"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message10"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message11"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message12"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message13"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message14"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message15"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message16"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message17"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message18"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message19"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message20"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message21"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message22"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message23"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'
    can_msg["message24"] = b'\x01\x23\x45\x67\x89\xAB\xCD\xEF\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E'

    return can_msg


while True:
    can_msg = generate_can_message()  # Create a random CAN message
    can_msg_json = ujson.dumps(can_msg)

    try:
        # Make the POST request with error handling
        print("CAN message JSON:", can_msg_json)
        print(utime.localtime())
        response = urequests.post(server_url, json=can_msg_json)
        print("Server Response:", response.text)
        print(utime.localtime())
    except Exception as e:
        print("Error sending POST request:", e)

    utime.sleep_ms(10000)
